webact=this.webact||{};(function(c,b){var a=function(i,g){var h,e,f;h=function(){};h.prototype=i;e=new h();if(g!==undefined){for(f in g){if(g.hasOwnProperty(f)){e[f]=g[f]}}}return e};c.create=a;var d={name:null,names:function(){var e,f;e=[];for(f in this){if(this.hasOwnProperty(f)&&f!=="name"){e.push(f)}}return e},exports:function(){var h,e,g,f;if(this.name===null){throw new Error("Package name not set")}h=this.names();e=[];for(g=0;g<h.length;g+=1){f=h[g];e.push("var "+f+"=webact."+this.name+"."+f)}return e.join(";")}};c.in_package=function(f,e){var g=c[f]||null;if(g===null){g=c.create(d,{name:f});c[f]=g}if(e!==undefined){e(g)}return g};c.imports=function(){var e,g,f,h;e=[];for(g=0;g<arguments.length;g+=1){f=arguments[g];h=c[f];if(h===undefined){throw new Error("Undefined package: "+f)}e.push(h.exports())}return e.join(";")}}(webact,jQuery));webact.in_package("paths",function(b){var a=function(d){var c=new Error("Invalid Path: "+d);c.name="InvalidPath";return c};b.split=function(g){var f=g.split("/");var c=[];for(var d=0;d<f.length&&f[d]==="";d+=1){c.push(f[d])}for(;d<f.length;d+=1){var e=f[d];if(e!==""){c.push(e)}}return c};b.join=function(){var e=[];for(var d=0;d<arguments.length;d+=1){var f=arguments[d];if(f==="/"){f=""}var g=b.split(f);for(var c=0;c<g.length;c+=1){e.push(g[c])}}return b.normalize(e.join("/"))};b.normalize=function(c){return b.split(c).join("/")};b.parent=function(d){var c=b.split(d);if((c.length===1&&c[0]==="")||(c.length===2&&c[0]===""&&c[1]==="")){throw a('parent("'+d+'")')}c=c.slice(0,c.length-1);if(c.length===1&&c[0]===""){return"/"}else{return c.join("/")}}});webact.in_package("observers",function(b){var a=Array.prototype.slice;b.mixinBroadcaster=function(c){var d={};c.addListener=function(e,h,f){var g=d[e];if(g===undefined){g=[];d[e]=g}if(typeof(h)==="function"){g.push(h)}else{if(f===undefined){f=e}g.push(function(){h[f].apply(h,arguments)})}};c.removeListener=function(e,h){var g=d[e];if(g===undefined){return false}var f=g.indexOf(h);if(f<0){return false}g.splice(f,1);return true};c.hasListener=function(e,g){var f=d[e];if(f===undefined){return false}return f.indexOf(g)>=0};c.sendBroadcast=function(e,j,i){if(i===undefined){i=this}var h=d[e];if(h===undefined){return}var g=j.slice();g.push(i);for(var f=0;f<h.length;f+=1){h[f].apply(null,g)}};c.broadcast=function(e){c.sendBroadcast(e,a.call(arguments,1))}};b.makeBroadcaster=function(){var c={};b.mixinBroadcaster(c);return c}});webact.in_package("controls",function(controls){eval(webact.imports("observers"));var id_counters={};controls.makeControl=function(options){options=options||{};var self=makeBroadcaster();self.class_name="Control";self.dom_element=null;self.dom_contents=null;self.parent=null;self.contents=null;var mouse_move_function=null;var mouse_up_function=null;var mouse_out_function=null;self.getId=function(suffix){if(this.id){return this.id}if(options.id){this.id=options.id;return this.id}var class_name=this.class_name;var count=id_counters[class_name]||0;id_counters[class_name]=count+1;this.id=this.class_name+"_"+count;return this.id};self.add=function(child){if(child.parent!==null){throw new Error("control added twice")}this.contents=this.contents||[];this.contents.push(child);child.parent=this;child.addedTo(this);if(this.dom_element){child.create(this.dom_contents)}};self.addedTo=function(parent){};self.detach=function(child){if(child){if(child.dom_element){child.remove()}var children=this.contents;for(var index=0;index<children.length;index+=1){if(children[index]===child){children.splice(index,1);break}}child.parent=null;child.detachedFrom(this)}else{this.parent.detach(this)}};self.detachedFrom=function(parent){if(this.dom_element){this.dom_element.remove()}this.dom_element=null;this.parent=null};self.generate=function(container){var dom_element=jQuery("<div/>",{id:this.getId()});container.append(dom_element)};self.update=function(){};var generateContents=function(){var contents=this.contents||[];var container=this.dom_contents;for(var index=0;index<contents.length;index+=1){contents[index].create(container)}};self.create=function(container){if(this.dom_element!==null){throw new Error("Control already generated: "+this.getId())}this.dom_contents=null;this.dom_element=this.generate(container);this.dom_contents=this.dom_contents||this.dom_element;generateContents();this.update()};self.remove=function(){var dom_element=this.dom_element;if(dom_element){dom_element.remove();this.dom_element=null;this.dom_contents=null}};self.isOver=function(x,y){var dom_element=self.dom_element;var offset=dom_element.offset();var right=offset.left+dom_element.width();var bottom=offset.top+dom_element.height();return x>=offset.left&&x<right&&y>=offset.top&&y<bottom};var trackMouseMove=function(event){if(mouse_move_function){mouse_move_function(event)}};var trackMouseUp=function(event){var up_function=mouse_up_function;self.stopTracking();if(up_function){up_function(event)}};var trackMouseOut=function(event){if(!self.isOver(event.pageX,event.pageY)){var out_function=mouse_out_function;self.stopTracking();if(out_function){out_function(event)}}};var ignoreEvent=function(event){return false};self.startTracking=function(move_function,up_function,out_function){mouse_move_function=move_function;mouse_up_function=up_function;mouse_out_function=out_function;self.dom_element.bind("mousemove",trackMouseMove);self.dom_element.bind("mouseup",trackMouseUp);var body=jQuery("body");body.bind("mouseout",trackMouseOut);body.bind("mousedown",ignoreEvent)};self.stopTracking=function(){self.dom_element.unbind("mousemove",trackMouseMove);self.dom_element.unbind("mouseup",trackMouseUp);var body=jQuery("body");body.unbind("mouseout",trackMouseOut);body.unbind("mousedown",ignoreEvent);mouse_move_function=null;mouse_out_function=null};self.hide=function(){if(this.dom_element){this.dom_element.hide()}};self.show=function(){if(this.dom_element){this.dom_element.show()}};return self}});webact.in_package("geometry",function(i){var q,h,p;var m={x:0,y:0};var e=function(r,s){return webact.create(m,{x:r,y:s})};i.makePoint=e;m.equals=function(r){return this.x===r.x&&this.y===r.y};m.pinInRectangle=function(r){return e(Math.max(r.left,Math.min(this.x,r.right)),Math.max(r.top,Math.min(this.y,r.bottom)))};m.round=function(s){s=s||6;var u=Math.pow(10,s);var r=Math.round(this.x*u)/u;var t=Math.round(this.y*u)/u;return e(r,t)};m.project=function(t){var r=this.x;var u=this.y;var s=t.matrix;return e(s[0]*r+s[1]*u+s[2],s[3]*r+s[4]*u+s[5])};m.to=function(t,s){var r;if(typeof(s)==="number"){r=e(t,s)}else{r=t}return webact.create(q,{from_x:this.x,from_y:this.y,to_x:r.x,to_y:r.y})};m.toString=function(){return"("+this.x+", "+this.y+")"};var b={width:0,height:0};var j=function(s,r){return webact.create(b,{width:s,height:r})};i.makeDimensions=j;b.equals=function(r){return this.width===r.width&&this.height===r.height};b.scale=function(r){return j(r*this.width,r*this.height)};b.rectangle=function(){return h(0,0,this.width,this.height)};b.polygon=function(){return this.rectangle().polygon()};b.toString=function(){return"Dimensions(width="+this.width+", height="+this.height+")"};q={from_x:0,from_y:0,to_x:0,to_y:0};q.from=function(){return e(this.from_x,this.from_y)};q.to=function(){return e(this.to_x,this.to_y)};q.length=function(){var s=this.to_x-this.from_x;var r=this.to_y-this.from_y;return Math.sqrt(s*s+r*r)};q.bounds=function(){return h(Math.min(this.from_x,this.to_x),Math.min(this.from_y,this.to_y),Math.max(this.from_x,this.to_x),Math.max(this.from_y,this.to_y))};q.yForX=function(s){var t=Math.min(this.from_x,this.to_x);var u=Math.max(this.from_x,this.to_x);if(s<t||s>u){return false}var r=(this.to_y-this.from_y)/(this.to_x-this.from_x);var v=this.from_y+(s-this.from_x)*r;return isNaN(v)?this.from_y:v};q.xForY=function(v){var t=Math.min(this.from_y,this.to_y);var u=Math.max(this.from_y,this.to_y);if(v<t||v>u){return false}var s=(this.to_x-this.from_x)/(this.to_y-this.from_y);var r=this.from_x+(v-this.from_y)*s;return isNaN(r)?this.from_x:r};q.equals=function(r){return this.from_x===r.from_x&&this.to_x===r.to_x&&this.from_y===r.from_y&&this.to_y===r.to_y};q.toString=function(){return this.from().toString()+".to"+this.to().toString()};var l={left:0,top:0,right:0,bottom:0};h=function(u,t,s,r){return webact.create(l,{left:u,top:t,right:s,bottom:r})};i.makeRectangle=h;var a=function(w,v,u,r){var t=w+u;var s=v+r;return webact.create(l,{left:w,top:v,right:t,bottom:s})};i.makeRectangleWidthHeight=a;l.dimensions=function(){return j(this.right-this.left,this.bottom-this.top)};l.topLeft=function(){return e(this.left,this.top)};l.bottomRight=function(){return e(this.right,this.bottom)};l.center=function(){return e((this.left+this.right)/2,(this.top+this.bottom)/2)};l.equals=function(r){return(this.left===r.left)&&(this.top===r.top)&&(this.right===r.right)&&(this.bottom===r.bottom)};l.containsPoint=function(r){return r.x>=this.left&&r.x<this.right&&r.y>=this.top&&r.y<this.bottom};l.intersect=function(r){var v=Math.max(this.left,r.left);var u=Math.max(this.top,r.top);var t=Math.min(this.right,r.right);var s=Math.min(this.bottom,r.bottom);return h(v,u,t,s)};l.inset=function(r,s){s=s||r;r=Math.min(r,(this.right-this.left)/2);s=Math.min(s,(this.bottom-this.top)/2);return h(this.left+r,this.top+s,this.right-r,this.bottom-s)};l.scale=function(r){return h(this.left*r,this.top*r,this.right*r,this.bottom*r)};l.polygon=function(){return p([e(this.left,this.top),e(this.right,this.top),e(this.right,this.bottom),e(this.left,this.bottom)])};l.toString=function(){return"Rectangle(left="+this.left+", top="+this.top+", right="+this.right+", bottom="+this.bottom+")"};var k={points:[]};p=function(r){return webact.create(k,{points:r})};i.makePolygon=p;k.bounds=function(){var v=this.points;if(v.length===0){throw new Error("Invalid operation")}var y=v[0];var x=y.x;var u=x;var w=y.y;var s=w;for(var t=0;t<v.length;t+=1){var r=v[t];x=Math.min(x,r.x);u=Math.max(u,r.x);w=Math.min(w,r.y);s=Math.max(s,r.y)}return h(x,w,u,s)};k.containsPoint=function(u){var t,s,r;t=this.points;s=0;this.forLines(this,function(w){var v=w.xForY(u.y);if(v!==false&&v>u.x){s+=1}});return(s%2)!==0};k.project=function(s){var t=this.points;var u=[];for(var r=0;r<t.length;r+=1){u.push(t[r].project(s))}return p(u)};k.equals=function(r){var u=this.points;var s=r.points;if(u.length!==s.length){return false}var v=0;while(v<u.length&&!u[0].equals(s[v])){v+=1}if(v===u.length){return false}for(var t=0;t<u.length;t+=1){if(!u[t].equals(s[(t+v)%u.length])){return false}}return true};k.forPoints=function(t,u){if(u===undefined){u=t;t=this}var s=this.points;for(var r=0;r<s.length;r+=1){u.call(t,s[r],r)}};k.forLines=function(w,x){if(x===undefined){x=w;w=this}var u=this.points;var s=u.length-1;for(var t=0;t<s;t+=1){var r=u[t].to(u[t+1]);x.call(w,r,t)}if(s>0){var v=u[s].to(u[0]);x.call(w,v,s)}};var d=function(u,t){var w=t.top;var v=[];for(var s=0;s<u.length;s+=1){var z=u[s];var y=u[(s+1)%u.length];if(z.y>=w){v.push(z)}if(z.y<w&&y.y>=w||z.y>=w&&y.y<w){var r=z.x+(w-z.y)*(y.x-z.x)/(y.y-z.y);v.push(e(r,w))}}return v};var g=function(u,t){var s=t.right;var v=[];for(var r=0;r<u.length;r+=1){var z=u[r];var x=u[(r+1)%u.length];if(z.x<=s){v.push(z)}if(z.x<=s&&x.x>s||z.x>s&&x.x<=s){var w=z.y+(s-z.x)*(x.y-z.y)/(x.x-z.x);v.push(e(s,w))}}return v};var f=function(v,u){var s=u.bottom;var w=[];for(var t=0;t<v.length;t+=1){var z=v[t];var y=v[(t+1)%v.length];if(z.y<=s){w.push(z)}if(z.y<=s&&y.y>s||z.y>s&&y.y<=s){var r=z.x+(s-z.y)*(y.x-z.x)/(y.y-z.y);w.push(e(r,s))}}return w};var n=function(t,s){var v=s.left;var u=[];for(var r=0;r<t.length;r+=1){var z=t[r];var x=t[(r+1)%t.length];if(z.x>=v){u.push(z)}if(z.x<v&&x.x>=v||z.x>=v&&x.x<v){var w=z.y+(v-z.x)*(x.y-z.y)/(x.x-z.x);u.push(e(v,w))}}return u};k.clip=function(s){var r=this.points;r=d(r,s);r=g(r,s);r=f(r,s);r=n(r,s);return p(r)};k.toString=function(){var s=[];var t=this.points;for(var r=0;r<t.length;r+=1){s.push(t[r].toString())}return"Polygon(points=["+t.join(", ")+"])"};var c={matrix:[1,0,0,0,1,0,0,0,1]};var o=function(r){return webact.create(c,{matrix:r})};c.compose=function(u){var s=this.matrix;var r=u.matrix;var t=[s[0]*r[0]+s[1]*r[3]+s[2]*r[6],s[0]*r[1]+s[1]*r[4]+s[2]*r[7],s[0]*r[2]+s[1]*r[5]+s[2]*r[8],s[3]*r[0]+s[4]*r[3]+s[5]*r[6],s[3]*r[1]+s[4]*r[4]+s[5]*r[7],s[3]*r[2]+s[4]*r[5]+s[5]*r[8],s[6]*r[0]+s[7]*r[3]+s[8]*r[6],s[6]*r[1]+s[7]*r[4]+s[8]*r[7],s[6]*r[2]+s[7]*r[5]+s[8]*r[8]];return o(t)};c.inverse=function(){var r=this.matrix;var t=(r[0]*r[4]*r[8]-r[0]*r[5]*r[7]-r[1]*r[3]*r[8]+r[1]*r[5]*r[6]+r[2]*r[3]*r[7]-r[2]*r[4]*r[6]);var s=[(r[4]*r[8]-r[5]*r[7])/t,-(r[1]*r[8]-r[2]*r[7])/t,(r[1]*r[5]-r[2]*r[4])/t,-(r[3]*r[8]-r[5]*r[6])/t,(r[0]*r[8]-r[2]*r[6])/t,-(r[0]*r[5]-r[2]*r[3])/t,(r[3]*r[7]-r[4]*r[6])/t,-(r[0]*r[7]-r[1]*r[6])/t,(r[0]*r[4]-r[1]*r[3])/t];return o(s)};c.toString=function(){var r=this.matrix;var t=[];for(var s=0;s<r.length;s+=1){t.push(r[s])}return"Transform(["+t.join(", ")+"])"};i.makeIdentity=function(){return o(c.matrix)};i.makeTranslate=function(s,r){return o([1,0,s,0,1,r,0,0,1])};i.makeScale=function(s,r){return o([s,0,0,0,r,0,0,0,1])};i.makeRotate=function(r){var t=Math.cos(r);var s=Math.sin(r);return o([t,-s,0,s,t,0,0,0,1])}});webact.in_package("pyramid",function(pyramid){eval(webact.imports("geometry"));var TILE_SIZE=256;var RESOLUTION_MULTIPLIER=Math.sqrt(2);var LOG_MULTIPLIER=Math.log(RESOLUTION_MULTIPLIER);pyramid.makePyramid=function(width,height){var self={width:width,height:height};var computeLayers=function(){var l_width=(Math.log(width)-Math.log(TILE_SIZE))/LOG_MULTIPLIER;var l_height=(Math.log(height)-Math.log(TILE_SIZE))/LOG_MULTIPLIER;return Math.ceil(Math.max(l_width,l_height))+1};var layer_count=computeLayers();self.tile_size=TILE_SIZE;self.layer_count=layer_count;self.dimensions=function(){return makeDimensions(self.width,self.height)};self.layers=function(){return layer_count};self.layerForScale=function(scale){var last_layer=layer_count-1;var level=Math.max(Math.log(scale)/-LOG_MULTIPLIER,0);return Math.max(last_layer-Math.floor(level+1e-7),0)};self.scaleForLayer=function(layer_number){var layer_index=layer_count-layer_number-1;return 1/Math.pow(RESOLUTION_MULTIPLIER,layer_index)};self.tileExtent=function(layer_number){var layer_index=layer_count-layer_number-1;var scale=Math.pow(RESOLUTION_MULTIPLIER,layer_index);return Math.floor(TILE_SIZE*scale)};self.tileGridSize=function(layer_number){var extent=self.tileExtent(layer_number);return makeDimensions(Math.ceil(width/extent),Math.ceil(height/extent))};self.tileSourceRectangle=function(column,row,layer_number){var layer_index=layer_count-layer_number-1;var scale=Math.pow(RESOLUTION_MULTIPLIER,layer_index);var extent=Math.floor(TILE_SIZE*scale);return makeRectangleWidthHeight(extent*column,extent*row,extent,extent)};self.clippedDimensions=function(column,row,layer_number){var layer_index=layer_count-layer_number-1;var scale=Math.pow(RESOLUTION_MULTIPLIER,layer_index);var tileRect=self.tileSourceRectangle(column,row,layer_number);var sceneRect=makeRectangleWidthHeight(0,0,width,height);var clippedTile=tileRect.intersect(sceneRect);var clippedWidth=Math.ceil(clippedTile.width/scale);var clippedHeight=Math.ceil(clippedTile.height/scale);return makeDimensions(clippedWidth,clippedHeight)};self.tileColumn=function(x,layer_number){var layer_index=layer_count-layer_number-1;var extent=TILE_SIZE*Math.pow(RESOLUTION_MULTIPLIER,layer_index);return Math.floor(x/extent)};self.tileRow=function(y,layer_number){var layer_index=layer_count-layer_number-1;var extent=TILE_SIZE*Math.pow(RESOLUTION_MULTIPLIER,layer_index);return Math.floor(y/extent)};self.forTiles=function(rectangle,layer_number,callback){var grid_size=self.tileGridSize(layer_number);var left=self.tileColumn(rectangle.left,layer_number);left=Math.max(0,Math.min(left,grid_size.width-1));var right=self.tileColumn(rectangle.right,layer_number);right=Math.max(0,Math.min(right,grid_size.width-1));var top=self.tileRow(rectangle.top,layer_number);top=Math.max(0,Math.min(top,grid_size.height-1));var bottom=self.tileRow(rectangle.bottom,layer_number);bottom=Math.max(0,Math.min(bottom,grid_size.height-1));for(var row=top;row<=bottom;row+=1){for(var column=left;column<=right;column+=1){callback(column,row,layer_number,self)}}};return self};pyramid.loadPyramid=function(image_url,callback){var parseXML=function(xml){var xml_query=jQuery(xml);var root=xml_query.children().first();var dimensions=root.children().first();var width=parseInt(dimensions.attr("width"),10);var height=parseInt(dimensions.attr("height"),10);callback(pyramid.makePyramid(width,height))};jQuery.get(image_url+"/contents.xml",{},parseXML,"xml")}});webact.in_package("viewport",function(viewport){eval(webact.imports("observers"));eval(webact.imports("geometry"));var makeZoomAnimator;viewport.makeViewport=function(scene_size,view_size){var self=makeBroadcaster();var ZOOM_STEP=Math.SQRT2;var visible_size;var scale=0;var minimum_scale;var rotation=0;var center;var limits;var view_transform;var scene_transform;var view_polygon;var clipped_view_polygon;var pan_center=null;var pan_start=null;var center_start=null;var animator=makeZoomAnimator(self);var initializeCoordinates=function(){var horizontal_scale=view_size.width/scene_size.width;var vertical_scale=view_size.height/scene_size.height;minimum_scale=Math.min(horizontal_scale,vertical_scale);visible_size=view_size.scale(1/minimum_scale);scale=minimum_scale;center=makePoint(visible_size.width/2,visible_size.height/2)};var update=function(){var view_extent=view_size.scale(1/scale);var half_extent=view_extent.scale(1/2);limits=scene_size.rectangle().inset(half_extent.width,half_extent.height);center=center.pinInRectangle(limits);view_transform=makeTranslate(view_size.width/2,view_size.height/2).compose(makeScale(scale,scale)).compose(makeRotate(rotation)).compose(makeTranslate(-center.x,-center.y));scene_transform=view_transform.inverse();view_polygon=view_size.polygon().project(scene_transform);clipped_view_polygon=view_polygon.clip(scene_size.rectangle())};var initialize=function(){initializeCoordinates();update()};self.updateView=function(new_scale,new_center){scale=new_scale;center=new_center;update()};self.getViewSize=function(){return view_size};self.getSceneSize=function(){return scene_size};self.getScale=function(){return scale};self.getRotation=function(){return rotation};self.getCenter=function(){return center};self.getView=function(){return view_polygon};self.getClippedView=function(){return clipped_view_polygon};self.getViewTransform=function(){return view_transform};self.getSceneTransform=function(){return scene_transform};self.setScale=function(new_scale){new_scale=Math.min(1,Math.max(new_scale,minimum_scale));if(scale!==new_scale){scale=new_scale;update();this.broadcast("zoomed")}};self.setRotation=function(new_rotation){if(new_rotation<0){new_rotation+=2*Math.PI}if(rotation!==new_rotation){rotation=new_rotation;update();this.broadcast("changed")}};var snapToLayer=function(scale){var level=Math.ceil(Math.log(scale)/Math.log(ZOOM_STEP));var raw_scale=Math.pow(ZOOM_STEP,level);return Math.max(minimum_scale,Math.min(raw_scale,1))};var boxScale=function(box){var dimensions=box.dimensions();var horizontal_scale=view_size.width*scale/dimensions.width;var vertical_scale=view_size.height*scale/dimensions.height;return snapToLayer(Math.min(horizontal_scale,vertical_scale))};self.canZoomIn=function(){return scale<1};self.zoomIn=function(center){var new_scale=snapToLayer(scale*ZOOM_STEP);if(new_scale>=1){return}animator.zoomTo(new_scale,center)};self.canZoomOut=function(){return scale>minimum_scale};self.zoomOut=function(center){var new_scale=snapToLayer(scale/ZOOM_STEP);if(new_scale<minimum_scale){return}animator.zoomTo(new_scale,center)};self.zoomReset=function(){animator.zoomTo(minimum_scale,center)};self.zoomBox=function(view_box){var target_center=view_box.center().project(scene_transform);var dimensions=view_box.dimensions();var target_scale=0;if(dimensions.width>2&&dimensions.height>2){target_scale=boxScale(view_box)}else{target_scale=snapToLayer(scale*ZOOM_STEP)}animator.zoomTo(target_scale,target_center)};self.startPan=function(new_pan_start){pan_start=new_pan_start;pan_center=center};self.isPanning=function(){return pan_start!==null};self.pan=function(view_point){if(pan_center===null){return}var offset_x=(pan_start.x-view_point.x)/scale;var offset_y=(pan_start.y-view_point.y)/scale;center=makePoint(pan_center.x+offset_x,pan_center.y+offset_y);center=center.pinInRectangle(limits);update();self.broadcast("refreshed")};self.endPan=function(){pan_center=null;pan_start=null;self.broadcast("changed")};self.cancelPan=function(){center=pan_center;pan_center=null;update();self.broadcast("changed")};self.startCenter=function(scene_center){center_start=scene_center;self.centerOn(scene_center)};self.centerOn=function(scene_center){if(center.equals(scene_center)){return}center=scene_center.pinInRectangle(limits);update();self.broadcast("refreshed")};self.endCenter=function(){center_start=null;self.broadcast("changed")};self.toString=function(){return("Viewport(scale="+scale+", center="+center+", scene_size="+scene_size+")")};initialize();return self};makeZoomAnimator=function(viewport){var self={};var DELAY=1;var timer=null;var target_scale=null;var target_center=null;var steps=0;var step_count=0;var finish=function(){viewport.updateView(target_scale,target_center);viewport.broadcast("zoomed")};var update=function(){var scale=viewport.getScale();var new_scale=(target_scale+scale)/2;var center=viewport.getCenter();var new_center=makePoint(center.x+(target_center.x-center.x)/2,center.y+(target_center.y-center.y)/2);viewport.updateView(new_scale,new_center);viewport.broadcast("refreshed")};var step=function(){step_count+=1;if(step_count<steps){update();timer=setTimeout(step,DELAY)}else{finish();timer=null}};var start=function(){if(timer!==null){return}var scale=viewport.getScale();var level=Math.ceil(Math.log(scale)/Math.log(Math.SQRT2));var goal_level=Math.ceil(Math.log(target_scale)/Math.log(Math.SQRT2));steps=Math.abs(level-goal_level)+2;step_count=0;timer=setTimeout(step,DELAY)};self.zoomTo=function(new_scale,new_center){target_scale=new_scale||viewport.getScale();target_center=new_center||viewport.getCenter();start()};return self}});webact.in_package("tiled_image",function(tiled_image){eval(webact.imports("geometry"));eval(webact.imports("pyramid"));var pad=function(number,width){var text=""+number;while(text.length<width){text="0"+text}return text};var tile={layer:0,column:0,row:0,tile_url:null,pyramid:null,loaded:false,shown:false};var makeTile=function(image_url,layer,column,row,pyramid){var tile_url=image_url+"/layer"+pad(layer,4)+"/tile"+pad(row,4)+"n"+pad(column,4)+".jpg";return webact.create(tile,{layer:layer,column:column,row:row,tile_url:tile_url,pyramid:pyramid})};tiled_image.makeTile=makeTile;tile.generate=function(container){var element=jQuery("<img/>",{src:this.tile_url,style:"position: absolute",draggable:false});container.append(element);this.element=element;element.load(this,function(event){var self=event.data;self.loaded=true;if(self.shown){element.show()}});element.hide()};tile.draw=function(x,y,size){var element=this.element;this.shown=true;element.css({left:x,top:y,width:size,height:size});if(this.loaded){this.element.show()}};tile.hide=function(){this.shown=false;this.element.hide()};var makeLayer=function(image_url,layer_number,pyramid,viewport){var layer={layer_number:layer_number};var element=null;var columns=0;var rows=0;var scale=1;var tiles=[];var shown=[];var initializeTiles=function(){tiles=[];for(var row=0;row<rows;row+=1){var row_tiles=[];for(var col=0;col<columns;col+=1){row_tiles.push(null)}tiles.push(row_tiles)}};var initialize=function(){var grid_size=pyramid.tileGridSize(layer_number);columns=grid_size.width;rows=grid_size.height;scale=pyramid.scaleForLayer(layer_number);initializeTiles()};var computeOrigin=function(visible_rectangle){var left=pyramid.tileColumn(visible_rectangle.left,layer_number);left=Math.max(0,Math.min(left,columns-1));var top=pyramid.tileRow(visible_rectangle.top,layer_number);top=Math.max(0,Math.min(top,rows-1));return makePoint(left,top)};var computeOffset=function(origin,visible_rectangle,scaled_tile_size,desired_scale){var left=(origin.x*scaled_tile_size)-visible_rectangle.left*desired_scale;var top=(origin.y*scaled_tile_size)-visible_rectangle.top*desired_scale;return makePoint(left,top)};var drawTile=function(col,row,origin,size,offset){var tile=tiles[row][col];if(tile===null){tile=makeTile(image_url,layer_number,col,row,pyramid);tiles[row][col]=tile;tile.generate(element)}var x=Math.round((col-origin.x)*size+offset.x);var y=Math.round((row-origin.y)*size+offset.y);tile.draw(x,y,Math.floor(size));shown.push(tile)};layer.draw=function(){var view_rectangle=viewport.getView().bounds();var desired_scale=viewport.getScale();var origin=computeOrigin(view_rectangle);var scaled_tile_size=pyramid.tile_size*(desired_scale/scale);var offset=computeOffset(origin,view_rectangle,scaled_tile_size,desired_scale);layer.hide();pyramid.forTiles(view_rectangle,layer_number,function(col,row){drawTile(col,row,origin,scaled_tile_size,offset)})};var refreshTile=function(col,row,origin,size,offset){var tile=tiles[row][col];if(tile!==null){var x=Math.round((col-origin.x)*size+offset.x);var y=Math.round((row-origin.y)*size+offset.y);tile.draw(x,y,Math.floor(size));shown.push(tile)}};layer.refresh=function(){var view_rectangle=viewport.getView().bounds();var desired_scale=viewport.getScale();var origin=computeOrigin(view_rectangle);var scaled_tile_size=pyramid.tile_size*(desired_scale/scale);var offset=computeOffset(origin,view_rectangle,scaled_tile_size,desired_scale);layer.hide();pyramid.forTiles(view_rectangle,layer_number,function(col,row){refreshTile(col,row,origin,scaled_tile_size,offset)})};layer.hide=function(){for(var index=0;index<shown.length;index+=1){shown[index].hide()}shown=[]};layer.generate=function(container){element=jQuery("<div/>",{id:"layer"+pad(layer_number,4),style:"position: abolute;"});container.append(element);return element};initialize();return layer};tiled_image.makeLayer=makeLayer;var makeTiledImage=function(image_url,pyramid,viewport){var self={pyramid:null};var element=null;var layers=[];var is_panning=false;var pan_start=null;var initialize=function(){viewport.addListener("changed",self);viewport.addListener("zoomed",self,"changed");viewport.addListener("refreshed",self)};var createLayers=function(){layers=[];var layer_count=pyramid.layers();for(var layer_number=0;layer_number<layer_count;layer_number+=1){var layer=makeLayer(image_url,layer_number,pyramid,viewport);layer.generate(element);layers.push(layer)}};var draw=function(){var layer_number=pyramid.layerForScale(viewport.getScale());var layer_count=pyramid.layers();for(var index=0;index<layer_count;index+=1){var layer=layers[index];if(index<=layer_number){layer.draw()}else{layer.hide()}}};var refresh=function(){var layer_number=pyramid.layerForScale(viewport.getScale());var layer_count=pyramid.layers();for(var index=0;index<layer_count;index+=1){var layer=layers[index];if(index<=layer_number){layer.refresh()}else{layer.hide()}}};var generate=function(container){element=jQuery("<div/>",{style:"position:relative;width:700px;height:660px;overflow:hidden;"});container.append(element);self.width=pyramid.width;self.height=pyramid.height;createLayers();this.element=element;var offset=element.offset();draw();return element};self.generate=generate;self.changed=function(){draw()};self.refreshed=function(){refresh()};self.toString=function(){return"TiledImage(width="+self.width+", height="+self.height+")"};initialize();return self};tiled_image.makeTiledImage=makeTiledImage});webact.in_package("viewer",function(viewer){eval(webact.imports("geometry"));eval(webact.imports("pyramid"));eval(webact.imports("viewport"));eval(webact.imports("tiled_image"));eval(webact.imports("controls"));var makeSelector;var SELECT_MODE=0;var PAN_MODE=1;viewer.SELECT_MODE=SELECT_MODE;viewer.PAN_MODE=PAN_MODE;viewer.makeViewer=function(options){var self=makeControl(options);var mode=SELECT_MODE;var shift_mode=false;var width=options.width;var height=options.height;var image_url=options.image_url;var image=null;var viewport=null;var selector=null;self.getViewport=function(){return viewport};self.getImageURL=function(){return image_url};self.generate=function(container){var dom_element=jQuery("<div/>",{"class":"wa_image_viewer"});dom_element.css("width",width);dom_element.css("height",height);container.append(dom_element);if(options.css){dom_element.addClass(options.css)}dom_element.data("_control",this);self.load(image_url,dom_element);return dom_element};self.getMode=function(){return mode};var setMode=function(new_mode){if(new_mode===undefined){new_mode=(mode===SELECT_MODE)?PAN_MODE:SELECT_MODE}if(new_mode!==mode){mode=new_mode;if(mode===PAN_MODE){self.dom_element.css("cursor","move")}else{self.dom_element.css("cursor","default")}self.broadcast("onModeChange",new_mode)}};self.setMode=setMode;var onPan=function(event){var mouse_point=makePoint(event.pageX,event.pageY);viewport.pan(mouse_point);setMode(mode)};var onPanEnd=function(event){var element=self.dom_element;viewport.endPan()};var onPanOut=function(event){if(!self.isOver(event.pageX,event.pageY)){viewport.endPan()}};var onMouseDown=function(event){var element=self.dom_element;var mouse_point=makePoint(event.pageX,event.pageY);if(mode===PAN_MODE){viewport.startPan(mouse_point);self.startTracking(onPan,onPanEnd,onPanOut)}else{if(mode===SELECT_MODE){selector.select(mouse_point,event)}}};var onKey=function(event){if(event.shiftKey){if(!shift_mode){setMode();shift_mode=true}}else{if(shift_mode){setMode();shift_mode=false}}};self.load=function(image_url,dom_element){loadPyramid(image_url,function(pyramid){viewport=makeViewport(pyramid.dimensions(),makeDimensions(width,height));image=makeTiledImage(image_url,pyramid,viewport);image.generate(dom_element,dom_element);selector=makeSelector(self,viewport);selector.create(dom_element);dom_element.mousedown(onMouseDown);jQuery("body").bind("keydown",onKey);jQuery("body").bind("keyup",onKey);setMode(mode);self.broadcast("loaded")})};self.canZoomIn=function(){return viewport.canZoomIn()};self.zoomIn=function(){return viewport.zoomIn()};self.canZoomOut=function(){return viewport.canZoomOut()};self.zoomOut=function(){viewport.zoomOut()};self.zoomReset=function(){viewport.zoomReset()};self.setScale=function(scale){viewport.setScale(scale)};return self};makeSelector=function(viewer,viewport){var self=makeControl({});var offset=null;var start=null;self.generate=function(container){var dom_element=jQuery("<div/>",{"class":"wa_image_selector"});container.append(dom_element);dom_element.hide();return dom_element};var onMouseMove=function(event){self.dom_element.css({left:Math.min(start.x,event.pageX)-offset.left,top:Math.min(start.y,event.pageY)-offset.top,width:Math.abs(event.pageX-start.x),height:Math.abs(event.pageY-start.y)})};var onMouseUp=function(event){self.hide();var zoom_box=makeRectangle(Math.min(start.x,event.pageX)-offset.left,Math.min(start.y,event.pageY)-offset.top,Math.max(start.x,event.pageX)-offset.left,Math.max(start.y,event.pageY)-offset.top);viewport.zoomBox(zoom_box)};var onMouseOut=function(event){self.hide()};self.select=function(start_point){start=start_point;offset=viewer.dom_element.offset();var element=self.dom_element;element.css("left",start_point.x-offset.left);element.css("top",start_point.y-offset.top);element.css("width",0);element.css("height",0);self.show();viewer.startTracking(onMouseMove,onMouseUp,onMouseOut)};return self}});webact.in_package("viewer_controls",function(viewer_controls){eval(webact.imports("geometry"));eval(webact.imports("pyramid"));eval(webact.imports("viewport"));eval(webact.imports("controls"));eval(webact.imports("viewer"));var makeNavigator,makeZoomSlider,makeViewerButtons;viewer_controls.makeViewerControls=function(viewer){var self=makeControl({});var viewport=null;var image_url=null;var position=null;var size=null;var icon_size=null;var icon=null;var panel=null;var is_shown=true;var initialize=function(){viewer.addListener("loaded",self)};var onMouseMove;var showPanel=function(){if(!is_shown){this.dom_element.css(position);icon.hide();panel.show();var body=jQuery("body");body.bind("mousemove",onMouseMove);body.bind("mouseout",onMouseMove);is_shown=true}};var hidePanel=function(){if(is_shown){var dom_element=this.dom_element;dom_element.css({left:position.left+size.width-icon_size.width,top:position.top+size.height-icon_size.height});icon.show();panel.hide();var body=jQuery("body");body.unbind("mousemove",onMouseMove);body.unbind("mouseout",onMouseMove);is_shown=false}};var isMouseOver=function(event){var offset=self.dom_element.offset();var pageX=event.pageX;var pageY=event.pageY;return(pageX>=offset.left&&pageX<=(offset.left+size.width)&&pageY>=offset.top&&pageY<=(offset.top+size.height))};onMouseMove=function(event){if(isMouseOver(event)){showPanel()}else{hidePanel()}};self.generate=function(container){var dom_element=jQuery("<div/>",{"class":"wa_image_controls"});container.append(dom_element);dom_element.bind("mousemove",onMouseMove);return dom_element};var generatePanel=function(dom_element){panel=jQuery("<div/>",{"class":"wa_image_panel"});dom_element.append(panel);this.dom_element=dom_element;panel.css({width:size.width-2,height:size.height-2});var navigator=makeNavigator(viewport,image_url);navigator.create(panel);var slider=makeZoomSlider(viewport,size.height-154);slider.create(panel);var buttons=makeViewerButtons(viewer);buttons.create(panel)};var generateIcon=function(dom_element){var scene_size=viewport.getSceneSize();var width=64;var height=scene_size.height*width/scene_size.width;icon_size=makeDimensions(width,height);icon=jQuery("<div/>",{"class":"wa_image_icon"});dom_element.append(icon);icon.css({left:0,top:0});var shadow=jQuery("<img/>",{src:"../../images/semishadow.png"});shadow.css({left:5,top:5,width:width,height:height});icon.append(shadow);var image=jQuery("<img/>",{src:image_url+"/thumbnail.jpg","class":"wa_image_small"});image.css("width",width);icon.append(image)};var positionControls=function(size){var viewer_element=viewer.dom_element;var viewer_position=viewer_element.offset();var viewer_width=viewer_element.width();var viewer_height=viewer_element.height();position={left:viewer_position.left+viewer_width-size.width-10,top:viewer_position.top+viewer_height-size.height-10}};self.loaded=function(){var dom_element=self.dom_element;viewport=viewer.getViewport();image_url=viewer.getImageURL();var scene_size=viewport.getSceneSize();var height=Math.max(scene_size.height*(150/scene_size.width)+20,200);size=makeDimensions(187,height);dom_element.css({width:size.width,height:size.height});positionControls(size);generateIcon(dom_element);generatePanel(dom_element);hidePanel()};initialize();return self};makeNavigator=function(viewport,image_url){var navigator=makeControl({});var top=0;var left=0;var width=150;var height=0;var scale=0;var indicator=null;var is_tracking=false;var initialize=function(){var scene_size=viewport.getSceneSize();scale=width/scene_size.width;height=Math.round(scene_size.height*scale);viewport.addListener("changed",navigator);viewport.addListener("zoomed",navigator,"changed");viewport.addListener("refreshed",navigator,"changed")};var onMouseMove=function(event){event.stopPropagation();var center=makePoint(Math.round((event.pageX-left)/scale),Math.round((event.pageY-top)/scale));viewport.centerOn(center)};var onMouseUp=function(event){event.stopPropagation();viewport.endCenter()};var onMouseDown=function(event){event.preventDefault(true);event.stopPropagation();var offset=navigator.dom_element.offset();left=offset.left;top=offset.top;var center=makePoint(Math.round((event.pageX-left)/scale),Math.round((event.pageY-top)/scale));viewport.startCenter(center);navigator.startTracking(onMouseMove,onMouseUp,onMouseUp)};navigator.generate=function(container){var dom_element=jQuery("<div/>",{"class":"wa_image_navigator"});container.append(dom_element);var thumbnail=jQuery("<img/>",{src:image_url+"/thumbnail.jpg","class":"wa_image_thumbnail",draggable:false,width:width,height:height});dom_element.append(thumbnail);indicator=jQuery("<div/>",{"class":"wa_image_indicator",width:width-2,height:height-2});dom_element.append(indicator);dom_element.bind("mousedown",onMouseDown);return dom_element};navigator.changed=function(){var rectangle=viewport.getView().bounds().scale(scale);var dimensions=rectangle.dimensions();var position={left:Math.max(Math.round(rectangle.left),0),top:Math.max(Math.round(rectangle.top),0),width:Math.min(Math.round(dimensions.width),width)-2,height:Math.min(Math.round(dimensions.height),height)-2};indicator.css(position)};initialize();return navigator};viewer_controls.makeNavigator=makeNavigator;makeZoomSlider=function(viewport,slider_height){var slider=makeControl({});var initialize=function(){viewport.addListener("zoomed",slider)};var adjustZoom=function(event,ui){viewport.setScale(ui.value/100)};slider.generate=function(container){var dom_element=jQuery("<div/>",{"class":"wa_image_slider"});container.append(dom_element);dom_element.slider({orientation:"vertical",slide:adjustZoom});dom_element.css("height",slider_height);return dom_element};slider.zoomed=function(){var dom_element=slider.dom_element;dom_element.slider("option","value",Math.round(100*viewport.getScale()))};initialize();return slider};makeViewerButtons=function(viewer){var self=makeControl({});var viewport=viewer.getViewport();var in_button=null;var out_button=null;var reset_button=null;var zoom_button=null;var pan_button=null;var initialize=function(){viewer.addListener("onModeChange",self);viewport.addListener("zoomed",self)};var zoomIn=function(event){event.stopPropagation();viewport.zoomIn()};var zoomOut=function(event){event.stopPropagation();viewport.zoomOut()};var zoomReset=function(event){event.stopPropagation();viewport.zoomReset()};var zoomMode=function(event){event.stopPropagation();viewer.setMode(SELECT_MODE)};var panMode=function(event){event.stopPropagation();viewer.setMode(PAN_MODE)};self.generate=function(container){var dom_element=jQuery("<div/>",{"class":"wa_image_buttons"});container.append(dom_element);in_button=jQuery("<a/>",{"class":"wa_in_button"});dom_element.append(in_button);in_button.button({icons:{primary:"ui-icon-plus"},text:false,label:"Zoom In"});in_button.click(zoomIn);out_button=jQuery("<a/>",{"class":"wa_out_button"});dom_element.append(out_button);out_button.button({icons:{primary:"ui-icon-minus"},text:false,label:"Zoom Out"});out_button.click(zoomOut);reset_button=jQuery("<a/>",{"class":"wa_reset_button"});dom_element.append(reset_button);reset_button.button({icons:{primary:"ui-icon-refresh"},text:false,label:"Reset"});reset_button.click(zoomReset);zoom_button=jQuery("<a/>",{"class":"wa_zoom_button"});dom_element.append(zoom_button);zoom_button.button({icons:{primary:"ui-icon-search"},text:false,label:"Zoom Mode"});zoom_button.click(zoomMode);pan_button=jQuery("<a/>",{"class":"wa_pan_button"});dom_element.append(pan_button);pan_button.button({icons:{primary:"ui-icon-arrow-4"},text:false,label:"Pan Mode"});pan_button.click(panMode);self.zoomed();self.onModeChange();return dom_element};self.zoomed=function(){in_button.button(viewport.canZoomIn()?"enable":"disable");out_button.button(viewport.canZoomOut()?"enable":"disable")};self.onModeChange=function(){var mode=viewer.getMode();if(mode===SELECT_MODE){zoom_button.button("disable");pan_button.button("enable")}else{zoom_button.button("enable");pan_button.button("disable")}};initialize();return self}});